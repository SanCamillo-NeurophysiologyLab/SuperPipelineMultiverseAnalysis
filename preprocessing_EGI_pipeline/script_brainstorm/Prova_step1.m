% Script generated by Sara Zago (19/01/23)

% Input files
sFiles = {...
    'PATHS_103/@rawPATHS_103_ASSR_20191126_034621/data_0raw_PATHS_103_ASSR_20191126_034621.mat', ...
    'PATHS_108/@rawPATHS_108_ASSR_20200128_105847/data_0raw_PATHS_108_ASSR_20200128_105847.mat', ...
    'PATHS_111/@rawPATHS_111_ASSR_20200219_120243/data_0raw_PATHS_111_ASSR_20200219_120243.mat', ...
    'PATHS_140/@rawPATHS_140_pre_ASSR_20220527_014438/data_0raw_PATHS_140_pre_ASSR_20220527_014438.mat', ...
    'PATHS_149/@rawPATHS_149_ASSR_PRE_20221220_025222/data_0raw_PATHS_149_ASSR_PRE_20221220_025222.mat'};

% Start a new report
bst_report('Start', sFiles);

% Process: Add EEG positions
sFiles = bst_process('CallProcess', 'process_channel_addloc', sFiles, [], ...
    'channelfile', {'', ''}, ...
    'usedefault',  90, ...  % NotAligned: ASA 10-05 343
    'fixunits',    1, ...
    'vox2ras',     1);

% Process: Set bad channels
sFiles = bst_process('CallProcess', 'process_channel_setbad', sFiles, [], ...
    'sensortypes', 'E67,E73,E82,E91,E92,E102,E111,E120,E133,E145,E165,E174,E187,E199,E208, E209, E216,E217,E218,E219,E225,E226,E227,E228,E229,E230,E231,E232,E233,E234,E235, E236,E237,E238,E239,E240,E241,E242,E243,E244,E245,E246,E247,E248,E249,E250, E251,E252,E253,E254,E255,E256');

% Process: Resample: 250Hz
sFiles = bst_process('CallProcess', 'process_resample', sFiles, [], ...
    'freq',     250, ...
    'read_all', 0);

% Process: Band-pass:0.5Hz-48Hz
sFiles = bst_process('CallProcess', 'process_bandpass', sFiles, [], ...
    'sensortypes', 'EEG', ...
    'highpass',    0.5, ...
    'lowpass',     48, ...
    'tranband',    0, ...
    'attenuation', 'strict', ...  % 60dB
    'ver',         '2019', ...  % 2019
    'mirror',      0, ...
    'read_all',    0);

% Process: Convert to simple event
sFiles = bst_process('CallProcess', 'process_evt_simple', sFiles, [], ...
    'eventname', 'DIN1, DIN2', ...
    'method',    1);  % Keep the start of the events


%% 
% MANUAL!
% Inspect raw recording to set bad segments and set eventual bad channels pre ICA
% Segments deleted contain movements, muscular artifact, electric
% artifact
%%

% Process: ICA components: Infomax
sFiles = bst_process('CallProcess', 'process_ica', sFiles, [], ...
    'timewindow',   [0, 363.164], ...
    'eventname',    '', ...
    'eventtime',    [0, 0], ...
    'resample',     0, ...
    'bandpass',     [0, 0], ...
    'nicacomp',     65, ...
    'sensortypes',  'EEG', ...
    'icasort',      '', ...
    'usessp',       1, ...
    'ignorebad',    1, ...
    'saveerp',      0, ...
    'method',       1);  % Infomax:    EEGLAB / RunICA

%% MANUAL
% Inspecting and deleting ICA components
%%
SubjectNames = {'PATHS_103', 'PATHS108', 'PATHS111', 'PATHS140', 'PATHS145'};

for iSubj = 1:length(subj_names)
    curr_subj = subj_names{iSubj};
    
% Process: Import MEG/EEG: Events
sFiles = bst_process('CallProcess', 'process_import_data_event', sFiles, [], ...
    'subjectname',   SubjectNames{1}, ...
    'condition',     '', ...
    'eventname',     'DIN1, DIN2', ...
    'timewindow',    [], ...
    'epochtime',     [-1.5, 1.5], ...
    'split',         0, ...
    'createcond',    1, ...
    'ignoreshort',   1, ...
    'usectfcomp',    1, ...
    'usessp',        1, ...
    'freq',          [], ...
    'baseline',      [], ...
    'blsensortypes', 'EEG');

%% MANUAL!!
% Trial rejection 

% Process: Average: By trial group (folder average)
sFiles = bst_process('CallProcess', 'process_average', sFiles, [], ...
    'avgtype',       5, ...  % By trial group (folder average)
    'avg_func',      1, ...  % Arithmetic average:  mean(x)
    'weighted',      0, ...
    'keepevents',    0);



end


